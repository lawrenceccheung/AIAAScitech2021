\section{Methodology}
Write something about what we're comparing with, the codes we're
using, and how we set up the simulations.

\subsection{Measured offshore conditions}
% \fxnote{Lawrence write this part}

Following the work of Cheung et al \cite{cheung2020large}, we use
measurements of the offshore coastal marine boundary layer, collected
by the Cape Wind meteorological tower in Nantucket Sound, as the basis
for this computational study.  The Cape Wind platform collected wind
measurements at 20m, 41m, and 60m above the mean water level, along
with temperature and barometric measurements from the years 2003-2011.
From the observations, Archer et al.\cite{archer2016predominance}
found that the marine boundary layer is predominantly unstable, with
61\% of conditions classified as unstable, versus 21\% neutral and
18\% stable.  The stratification of the marine boundary layer, as
determined by the Obukhov length, also had a large impact on the wind
speed profile, with flatter, non-logarithmic profiles seen during
unstable conditions.

From the measured distribution of atmospheric stabilities, turbulent
kinetic energies (TKE), and wind speeds from the Cape Wind platform at
z=20m, a stable set of conditions were chosen as targets for this
computational study.  A summary of the conditions for all stability
classes is given table \ref{tab:CapeWindMeasurements}. In this work we
focus on the three stable atmospheric conditions at wind speeds of
5m/s, 10m/s, and 15m/s, while the neutral and unstable conditions
where studied in previous work \cite{cheung2020large}.

To maintain consistency with the measured data, the turbulence
intensity (TI) is calculated using the TKE as
\begin{equation}
  \textrm{TI} =
  \frac{\sqrt{\frac{2}{3}\times\textrm{TKE}}}{\overline{U}_{horiz}} =
  \frac{\sqrt{\frac{1}{3}\left( \overline{u'u' + v'v' + w'w'}
      \right)}}{\overline{U}_{horiz}}
\end{equation}
The averaged wind speeds were enforced at the measurement height of
20m, and the applied wind directions were consistent with the
predominant stable direction of 225 degrees southwest.

\begin{table}
\caption{\label{tab:CapeWindMeasurements} Measured conditions at Cape
  Wind.  The stable atmospheric conditions used in this study are
  highlighted in bold below.} \centering
\begin{tabular}{cccc}
  \hline
  Stability    & Wind speed [m/s] & Wind dir [deg] & Turbulence intensity \\
  \hline
  Neutral      & 5                & 225            & 0.055           \\
  Neutral      & 10               & 225            & 0.055           \\
  Neutral      & 15               & 225            & 0.065           \\
  Unstable     & 5                & 315            & 0.080           \\
  Unstable     & 10               & 315            & 0.075           \\
  Unstable     & 15               & 315            & 0.090           \\
  \bf{Stable}  & \bf{5}           & \bf{225}       & \bf{0.045}      \\
  \bf{Stable}  & \bf{10}          & \bf{225}       & \bf{0.050}      \\
  \bf{Stable}  & \bf{15}          & \bf{225}       & \bf{0.060}      \\
\hline
\end{tabular}
\end{table}


\subsection{Computational methodology}
Provide a general description of the LES codes that we use.

Large Eddy Simulations (LES) of the stable atmopsheric conditions described in
Table~\ref{tab:CapeWindMeasurements} are performed using the open-source,
ExaWind simulation environment\footnote{\url{https://github.com/exawind}}.
ExaWind is a suite of high-fidelity modeling tools for analyzing complex
microscale atmospheric boundary layer flows and wind farm flows. The present
study uses two different incompressible computational fluid dynamic solvers
available within the ExaWind suite --
Nalu-Wind~\footnote{\url{https://github.com/exawind/nalu-wind}} and
AMR-Wind~\footnote{\url{https://github.com/exawind/amr-wind}}. This section
briefly describes the incompressible Navier-Stokes equations solved in the
solvers, the specifics of the turbulence model and the wall shear stress
formulation used to model the terrain, and the details of the numerical
discretization of the two equations in the two codes.

\subsection{LES formulation}

\subsubsection{Governing equations}
Both CFD codes solve the incompressible form of Navier-Stokes equations with
appropriate models for turbulence closure. Equation~\ref{eqn:ns-les} shows the
continuity and momentum equations with all the terms necessary to model the
atmospheric boundary layer problem. Term $\mathbf{I}$ represents the pressure
gradient forces as a deviation from hydrostatic and horizontal mean gradient,
term $\mathbf{II}$ represents the contribution from viscous and sub-filter scale
stresses, term $\mathbf{III}$ represents the contribution from Coriolis forces
due to earth's rotation, term $\mathbf{IV}$ represents the effects of buoyancy,
and term $\mathbf{V}$ represents source terms necessary to drive the flow to a
desired horizontal mean velocity at prescribed heights.

\begin{align}
  \frac{\partial \bar{\rho}} {\partial t} + \frac{\partial \bar{\rho} \widetilde{u_j}}{\partial x_j} & = 0, \nonumber\\
  \frac{\partial}{\partial t} \left(\bar{\rho}\, \widetilde{u}_i\right) +
  \frac{\partial}{\partial x_j} \left( \bar{\rho}\, \widetilde{u}_i \widetilde{u}_j \right) &=
  - \underbrace{\frac{\partial p'}{\partial x_j} \delta_{ij}}_\mathbf{I}
  - \underbrace{\frac{\partial \tau_{ij}}{\partial x_j}}_\mathbf{II}
  - \underbrace{2\bar{\rho}\,\epsilon_{ijk}\,\Omega_j\widetilde{u_k}}_\mathbf{III}
  + \underbrace{\left(\rho - \rho_\circ \right) g_i}_\mathbf{IV}
  + \underbrace{S^{u}_{i}}_\mathbf{V} \label{eqn:ns-les}
\end{align}

For the simulations presented in this paper, the buoyancy term ($\mathbf{IV}$)
is approximated using the Bousinessq model. The Bousinessq model ignores the
effect of density gradients on inertia while retaining its effects on buoyancy.
The density fluctuations governing the buoyancy effects are approximated as

\begin{align*}
  \frac{\rho}{\rho_\circ} \approx 1 - \beta \left( \theta - \theta_\circ \right)
\end{align*}
This leads to a forcing term that depends on potential temperature ($\theta$),
the reference density $\rho_\circ = \bar{\rho}$, and thermal expansion
coefficient $\beta \approx 1 / \theta_\circ$ as
\begin{align}
  \left(\rho - \rho_\circ \right) g_i = -\rho_\circ\, \beta\, g_i \left( \theta - \theta_\circ \right)
\end{align}

For ABL problems, the conservation of energy equation is usually written in
terms of potential temperature as shown in Eq.~\ref{eqn:pot-temp-les}.
\begin{align}
  \frac{\partial}{\partial t} \left(\bar{\rho}\, \widetilde{\theta}\right) +
  \frac{\partial}{\partial x_j} \left(\bar{\rho}\, \widetilde{u}_j \widetilde{\theta} \right) = - \frac{\partial}{\partial x_j} \hat{q}_j \label{eqn:pot-temp-les}
\end{align}
Under the assumption of ideal gas conditions and constant specific heat capacity
$c_p$, the gradients in potential temperature are proportional to the gradients
in absolute temperature, i.e.,
\begin{align*}
   \left[ \frac{\partial T}{\partial t}, \frac{\partial T}{\partial x}, \frac{\partial T}{\partial y} \right] =
   \left( \frac{\bar{p}}{p_\circ} \right)^{\left(\frac{R}{c_p}\right)} \left[ \frac{\partial \theta}{\partial t}, \frac{\partial \theta}{\partial x}, \frac{\partial \theta}{\partial y} \right]
\end{align*}
Furthermore, ignoring the pressure and viscous work terms in
Eq.~\ref{eqn:pot-temp-les}, for incompressible flows, it can be shown that
solving the enthalpy equation is equivalent to solving the potential temperature
equation. The enthalpy equation solved in Nalu-Wind for wind energy problems is
shown below
\begin{align}
  \frac{\partial}{\partial t} \left(\bar{\rho}\, \widetilde{h}\right) +
  \frac{\partial}{\partial x_j} \left(\bar{\rho}\, \widetilde{u}_j \widetilde{h} \right) = - \frac{\partial}{\partial x_j} q_j \label{eqn:enthalpy-les}
\end{align}
It is noted here that the terms $\hat{q}_j$ (Eq.~\ref{eqn:pot-temp-les}) and
$q_j$ (Eq.~\ref{eqn:enthalpy-les}) are not equivalent and must be scaled
appropriately. User can still provide the appropriate initial and boundary
conditions in terms of potential temperature field. Under these assumptions and
conditions, the resulting solution can then be interpreted as the variation of
potential temperature field in the computational domain.

The subgrid-scale kinetic energy ($k$) one-equation turbulence model
(Eq.~\ref{eqn:ksgs-les}), based on Moeng~\cite{Moeng1984}, is used for
LES turbulence closure.

\begin{align}
  \frac{\partial}{\partial t}\left(\bar{\rho} k \right) + \frac{\partial}{\partial x_j} \bar{\rho} k \widetilde{u_j} &= \frac{\partial}{\partial x_j} \left (2 \nu_t \frac{\partial k}{\partial x_j} \right) - 2 \nu_t \widetilde{S_{ij}} \widetilde{S_{ij}} + \frac{g}{\theta_\circ} \tau_{\theta_i} - C_{\epsilon} \frac{k^{3/2}}{l} \label{eqn:ksgs-les}
\end{align}
where
\begin{align*}
  C_\epsilon &= 0.93 & \nu_t &= C_\epsilon l \sqrt{k} \\
  \tau_{\theta i} &= - 2\ \frac{\nu_t}{\mathrm{Pr}_t}\ \frac{\partial \widetilde{\theta}}{\partial x_i} & \mathrm{Pr}_t &= \left( 1 + \frac{2l}{\Delta} \right)^{-1} \\
\end{align*}
The choice of the length scale ($l$) depends on whether the stratification is positive
or negative, based on the recommendation by Moeng~\cite{Moeng1984}, and is given
by
\begin{align*}
  l =
  \begin{cases}
    \Delta = \sqrt[3]{\Delta_x \Delta_y \Delta_z}, & \frac{\partial \widetilde{\theta}}{\partial z} < 0 \\
    0.76\, \sqrt{k}\, \frac{g}{\theta_\circ}\, \left( \frac{\partial \widetilde{\theta}}{\partial z}\right)^{-1/2}, &  \frac{\partial \widetilde{\theta}}{\partial z} > 0 \\
  \end{cases}
\end{align*}

\begin{comment}
  \fxnote{Shreyas write this part.  Currently placeholder equations below.}\\

  The low-Mach number equations:
  \begin{align}
    \frac{\partial \rho} {\partial t} + \frac{\partial \rho u_j}{\partial x_j} & = 0, \\
    \frac{\partial \rho u_i}{\partial t} + \frac{\partial \rho u_j u_i}{\partial x_j}
    + \frac{\partial P}{\partial x_i} & = \frac{\partial \tau_{ij}}{\partial x_j}
                                        + \left( \rho - \rho_{\circ} \right) g_i, \\
    \frac{\partial \rho h}{\partial t} + \frac{\partial \rho u_j h}{\partial x_j} & =
                                                                                    - \frac{\partial q_j}{\partial x_j} + \frac{\partial P_{th}}{\partial t},
  \end{align}
\end{comment}

\subsubsection{\label{sec:wallmodelBC}Lower wall model BC}
\fxnote{Ganesh write this part}\\
What we implemented in terms of the lower boundary condition.

\subsubsection{Nalu-Wind}

Nalu-Wind~\cite{SpragueAVR2020} is an open-source, wind-focused fork of the Nalu CFD
code~\cite{Domino:2015}. The codebase heavily leverages the open-source Trilinos
suite of numerical libraries~\cite{Heroux:2003}. Nalu-Wind uses an
unstructured-grid, node-centered, finite-volume formulation for solving the incompressible
Navier-Stokes equations. Two spatial discretization approaches are supported
within the codebase -- the edge-based scheme and control-volume finite-element
scheme. The edge-based scheme, used in the present study, is similar to the
classical cell-centered finite volume formulation formulated on a dual volume
surrounding the nodes of the mesh. The governing equations are discretized in
time using a split-operator approach. Implicit backward difference formula
(BDF2) timestepping algorithm with an approximate pressure projection
scheme~\cite{Moen-Domino:2003} is used to advance the equations in time.
Multiple Picard-style outer-loop iterations are employed within each timestep
to minimize the errors introduced from split-operator approximations. Nalu-Wind
comes equipped with a suite of Reynolds-Averaged Navier-Stokes (RANS), LES, and
Detached Eddy Simulation (DES) turbulence models to resolve the disparate
spatial and temporal scales encountered when modeling wind plant flows.

Nalu-Wind heavily utilizes the Sierra Toolkit (STK) library~\cite{Edwards:2010}
for managing the unstructured mesh data structures. The linear systems resulting
from the discretized equations are solved using solvers available within the
Belos and MueLu libraries within Trilinos. The momentum and scalar transport
equations are solved using GMRES iterative solver with symmetric Gauss-Seidel
(SGS) preconditioners. The elliptic pressure-Poisson equation is solved using
GMRES solvers with a smoothed-aggregated algebraic multigrid preconditioner. The
reader is referred to Sprague et al.~\cite{SpragueAVR2020} and
Domino~\cite{Domino:2015} more more details.

While the primary objective of Nalu-Wind within the ExaWind simulation suite is
to support blade-resolved simulations of wind turbines, it comes equipped
with all the physics models necessary for modeling atmospheric boundary flows.
In the present work, the prognostic equation for temperature is solved using the
enthalpy equation (Eq.~\ref{eqn:enthalpy-les}). The prognostic one-equation,
subgrid-scale kinetic energy equation (Eq.~\ref{eqn:ksgs-les}) is used for LES
turbulence closure. Two Picard iterations were employed within each timestep to
minimize splitting errors and recover second-order accuracy in time.

\subsubsection{AMR-Wind}

\fxnote{Do we want a github link reference for amr-wind? exawind?}\\

As part of a suite of physics codes within the open-source project called ExaWind, 
AMR-Wind enables more efficient and scalable simulations of wind power plants. 
This is because it is built on top of the AMReX software framework which contains 
all of the functionality needed to develop massively parallel, block-structured 
adaptive mesh refinement (AMR) applications \cite{AMReX_JOSS}.
Since AMR-Wind is limited to Cartesian block-structured grids it is specialized
to handle atmospheric boundary layer physics and wind turbine wakes. 
The block-structured grids enable more efficient algorithms such as 
Multi-Level Multi-Grid (MLMG) \cite{AMReX_JOSS}
and are well suited for next generation supercomputers that use GPU's. 

AMR-Wind solves the incompressible Navier-Stokes equations and is generalized to
handle variable density and viscosity. Additionally scalar transport equations can be 
solved such as potential temperature or turbulence models. The discretization in AMR-Wind
is based on the approximate projection method used in IAMR \cite{almgren1998conservative} 
and incflo \cite{sverdrup2018highly}. It is a semi-staggered scheme where the velocity and scalar 
variables are located at cell centers and pressure is located at nodes. Pressure is also staggered
in time so that pressure and the pressure gradient (located at cell centers) are at time $n+1/2$. 
The time discretization is handled with a Crank Nicholson approach where the right hand side 
of the system of equations is evaluated at time $n+1/2$. The advection term is handled explicitly
using an upwind finite-volume method. There are multiple options
within AMR-Wind, but in this paper only the high-order Godunov Piecewise Parabolic 
method (PPM) is used \cite{Colella1984}. The advection terms are projected to face 
centers at $n+1/2$ and are corrected using an exact MAC projection \cite{almgren1998conservative}
which guarantees a divergence free flow. The diffusion terms can be handled explicitly, semi-implicitly, 
or fully implicit and are the discretized using a second-order central difference formula. 
For the simulations in this paper we use a fully implicit scheme as the variable viscosity 
from the eddy viscosity may cause time step restrictions. After the scalar equations
and the momentum equations are advanced in time a nodal projection is used to 
approximately correct the velocity field to make it divergence free. Where the nodal projection
is based on a node centered finite element method \cite{almgren1998conservative}.

%IAMR paper \cite{almgren1998conservative}
%AMReX \cite{AMReX_JOSS}
%incflo \cite{sverdrup2018highly}
%Godunov ppm \cite{Colella1984}

\subsection{\label{sec:CFDsetup}Computational setup}
% \fxnote{Domains, grids, boundary conditions}


\begin{table}
\caption{\label{tab:z0tempparam} LES parameters for stable ABL conditions}
\centering
\begin{tabular}{ccccc}
  \hline
  Stability & Wind speed & Surface roughness $z_0$ & Surface
  temperature change & timestep\\
  \hline
  Stable       & 5  m/s           & 0.0005 m       & -0.32 K/hr   & 0.25 sec   \\
  Stable       & 10 m/s           & 0.0005 m       & -1.40 K/hr   & 0.125 sec  \\
  Stable       & 15 m/s           & 0.0005 m       & -1.50 K/hr   & 0.0625 sec \\
\hline
\end{tabular}
\end{table}

The computational methodology for the AMR-Wind and Nalu-Wind LES codes
follows practices similar to the previous offshore ABL study, with
some modifications to handle the stable stratification.  As in
\cite{cheung2020large}, the domain was a square prism geometry, with
the $x$ and $y$ coordinates aligned in the East and North directions,
respectively.  The domain size and mesh requirements were determined
through a numerical grid study.  As discussed in section
\ref{sec:gridstudy}, the horizontal dimensions of 750m $\times$ 750m
were found to be sufficient to capture any large scale structures in
the boundary layer, and in all cases the vertical dimension of 1000m
was also used.  The grid study in section \ref{sec:gridstudy} also
showed that the stable stratification required greater mesh refinement
to capture the smaller turbulent scales, and a uniform cell size of
2.5m was adopted for the offshore LES computations across both codes.

Momentum source terms were included in Nalu-Wind and AMR-Wind to
ensure that the horizontally averaged velocity matched the targeted
wind speed at the z=20 m height.  These source terms are based on the
difference between the desired wind velocity and the instantaneous
horizontally averaged velocity, and are only a function of time and
height z.  Coriolis forcing matching the Cape Wind latitude was
included to capture the effect of wind change with elevation.

\subsubsection{Boundary and initial conditions}
In both horizontal directions of the computational domain, periodic
boundary conditions were applied.  At the lower boundary, we chose to
represent the air/ocean interface using flat boundary with small
amount of surface roughness.  This allowed the wall model discussed in
section \ref{sec:wallmodelBC} to be applied.  Monin-Obukhov similarity
theory was used to determine the velocity and temperature profiles
near the lower surface given a surface roughness height $z_0$ and the
prescribed surface temperature as a function of time.  At the upper
surface of the domain, a potential flow based boundary condition is
applied along with a normal temperature gradient of 0.003 K/m.

The initial temperature profile in all cases was a constant 300K until
the specified inversion height of 650m.  The inversion layer thickness
was 100m, and above this, the temperature linearly increased until it
reached 308.75K at the upper boundary.  The initial mean velocity
profile was uniform throughout the domain with superimposed sinusoidal
velocity perturbations of magnitude 1 m/s to promote the development
of turbulence.

\subsubsection{Determination of surface roughness and prescribed temperature }
To match the measured TI conditions given in table
\ref{tab:CapeWindMeasurements}, the surface roughness and prescribed
surface temperature change were adjusted through an initial
trial-and-error process.  The final surface roughness of $z_0$=0.0005m
used the stable offshore conditions (see table \ref{tab:z0tempparam})
matched the roughness used in the neutral 15m/s and unstable 5m/s and
10m/s cases from the previous study \cite{cheung2020large}.  This
value of surface roughness is consistent with the measurements from
the North Sea \cite{taylor2001dependence}, which found values of $z_0$
ranging from $5 \times 10^{-5}$m to $5\times 10^{-3}$m.

The values of the prescribed temperature change at the ocean surface
is also given in table \ref{tab:CapeWindMeasurements}.  As the wind
speed increases, a larger temperature decrease was used to maintain
similar levels of stable stratification, as expected from
Monin-Obukhov similarity theory.

Once the appropriate surface roughness and prescribed temperature were
determined, and the correct mesh requirements known from the study in
section \ref{sec:gridstudy}, the LES computations for the stable 5m/s,
10m/s, and 15m/s ABL cases could be set up and run.  Each of the cases
was run for 15,000 seconds before collecting statistics for another
5,000 seconds.  To maintain a CFL number less than unity during these
runs, a smaller timestep was used for the higher wind speeds (see
table \ref{tab:z0tempparam}).
